- name: Read Helm Values File
  ansible.builtin.set_fact:
    helm_values_init: "{{ lookup('ansible.builtin.file', bootstrap_values_file) | from_yaml }}"

- name: Set Target Namespace for OpenShift Gitops Deployment
  ansible.builtin.set_fact:
    bootstrap_release_namespace: "{{ helm_values_init | community.general.json_query(_query) | first }}"
  vars:
    _query: "config.env[?name==`ARGOCD_CLUSTER_CONFIG_NAMESPACES`].value"

- name: Deploy OpenShift Gitops Operator
  kubernetes.core.helm:
    chart_ref: "{{ role_path }}/{{ bootstrap_charts_relative_path }}/operator"
    dependency_update: true
    release_name: "{{ bootstrap_operator_release_name }}"
    release_namespace: "{{ bootstrap_operator_release_namespace }}"
    values_files:
      - "{{ role_path }}/{{ bootstrap_values_file }}"
  register: results_helm_gitops_operator
  when:
    - not (global_use_infra_nodes | default(false))

- name: Deploy OpenShift Gitops Operator on Infrastructure Nodes
  kubernetes.core.helm:
    chart_ref: "{{ role_path }}/{{ bootstrap_charts_relative_path }}/operator"
    dependency_update: true
    release_name: "{{ bootstrap_operator_release_name }}"
    release_namespace: "{{ bootstrap_operator_release_namespace }}"
    values_files:
      - "{{ role_path }}/{{ bootstrap_values_file_infra_nodes }}"
  register: results_helm_gitops_operator
  when:
    - global_use_infra_nodes | default(false)

- name: Wait for argocds.argoproj.io CRD
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: argocds.argoproj.io
  delay: 5
  register: crd_results
  retries: 120
  until:
    - crd_results.resources is defined
    - crd_results.resources | length == 1

- name: Deploy Argo CD Using OpenShift GitOps Operator # noqa: jinja[spacing]
  kubernetes.core.helm:
    chart_ref: "{{ role_path }}/{{ bootstrap_charts_relative_path }}/argocd"
    create_namespace: true
    dependency_update: true
    release_name: "{{ bootstrap_argocd_release_name }}"
    release_namespace: "{{ bootstrap_release_namespace }}"
    set_values:
      - value: "global.baseline_disable_charts={ {{- global_baseline_disable_charts | default([]) | join(',') -}} }"
      - value: "global.use_infra_nodes={{ global_use_infra_nodes | default(false) }}"
    values_files:
      - "{{ role_path }}/{{ bootstrap_values_file }}"

- name: Wait for Argo CD Deployment
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1beta1
    kind: ArgoCD
    namespace: "{{ bootstrap_release_namespace }}"
  delay: 5
  register: argocd_results
  retries: 120
  until:
    - argocd_results.resources is defined
    - argocd_results.resources | count == 1
    - argocd_results.resources[0].status is defined
    - argocd_results.resources[0].status.applicationController is defined
    - argocd_results.resources[0].status.phase is defined
    - argocd_results.resources[0].status.applicationController == "Running"
    - argocd_results.resources[0].status.phase == "Available"

- name: Deploy Baseline Configuration
  kubernetes.core.helm:
    chart_ref: "{{ role_path }}/{{ bootstrap_charts_relative_path }}/bootstrap"
    dependency_update: true
    release_name: bootstrap
    release_namespace: "{{ bootstrap_release_namespace }}"
    set_values:
      - value: "global.use_infra_nodes={{ global_use_infra_nodes | default(false) }}"
    values_files:
      - "{{ role_path }}/{{ bootstrap_baseline_values_file }}"
  when:
    - (global_baseline_disable_charts | default([])) | count == 0

- name: Deploy Baseline Configuration With Disabled Chart(s) # noqa: jinja[spacing]
  kubernetes.core.helm:
    chart_ref: "{{ role_path }}/{{ bootstrap_charts_relative_path }}/bootstrap"
    dependency_update: true
    release_name: bootstrap
    release_namespace: "{{ bootstrap_release_namespace }}"
    set_values:
      - value: "global.baseline_disable_charts={ {{- global_baseline_disable_charts | join(',') -}} }"
      - value: "global.use_infra_nodes={{ global_use_infra_nodes | default(false) }}"
    values_files:
      - "{{ role_path }}/{{ bootstrap_baseline_values_file }}"
  when:
    - global_baseline_disable_charts is defined
    - global_baseline_disable_charts | count > 0
